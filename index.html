<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">
    <title>소화전 위치 찾기 - 내 위치 연동</title>
    <style>
        body,
        html {
            margin: 0;
            padding: 0;
            height: 100%;
        }

        #map {
            width: 100%;
            height: 100vh;
        }

        /* 내 위치 버튼 스타일 */
        .my-loc-btn {
            position: absolute;
            bottom: 30px;
            right: 20px;
            z-index: 5;
            background: #fff;
            border: 1px solid #ccc;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
            cursor: pointer;
        }

        .my-loc-btn img {
            width: 25px;
            height: 25px;
        }
    </style>
</head>

<body>

    <div id="map"></div>
    <div class="my-loc-btn" onclick="moveToMyLocation()">
        <img src="https://cdn-icons-png.flaticon.com/512/854/854894.png" alt="내 위치">
    </div>

    <script>
        const KAKAO_KEY = "a687556639bd8084c1afc610d81d324f";
        let map, myLocationMarker;

        const script = document.createElement('script');
        script.src = `https://dapi.kakao.com/v2/maps/sdk.js?appkey=${KAKAO_KEY}&autoload=false&libraries=clusterer`;
        document.head.appendChild(script);

        script.onload = () => {
            kakao.maps.load(async () => {
                const mapContainer = document.getElementById('map');
                const mapOption = {
                    center: new kakao.maps.LatLng(37.5665, 126.9780), // 초기값 서울시청
                    level: 8
                };
                map = new kakao.maps.Map(mapContainer, mapOption);

                const clusterer = new kakao.maps.MarkerClusterer({
                    map: map,
                    averageCenter: true,
                    minLevel: 6
                });

                try {
                    const response = await fetch('refined_data.json');
                    const fireHydrants = await response.json();

                    const markers = fireHydrants.map(item => {
                        const lat = parseFloat(item.la);
                        const lng = parseFloat(item.lo);
                        if (isNaN(lat) || isNaN(lng)) return null;

                        const marker = new kakao.maps.Marker({
                            position: new kakao.maps.LatLng(lat, lng)
                        });

                        const infowindow = new kakao.maps.InfoWindow({
                            content: `<div style="padding:5px;font-size:12px;color:black;">${item.n}<br>${item.a}</div>`
                        });

                        kakao.maps.event.addListener(marker, 'click', () => {
                            infowindow.open(map, marker);
                        });

                        return marker;
                    }).filter(m => m !== null);

                    clusterer.addMarkers(markers);

                    // 시작하자마자 내 위치 잡기
                    moveToMyLocation();

                } catch (err) {
                    console.error("데이터 로드 실패:", err);
                }
            });
        };

        // 내 위치를 찾아 지도를 이동시키고 마커를 찍는 함수
        function moveToMyLocation() {
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(pos => {
                    const lat = pos.coords.latitude;
                    const lng = pos.coords.longitude;
                    const myLatLng = new kakao.maps.LatLng(lat, lng);

                    // 기존 내 위치 마커가 있다면 제거하거나 위치만 이동
                    if (myLocationMarker) {
                        myLocationMarker.setPosition(myLatLng);
                    } else {
                        // 내 위치임을 나타내는 커스텀 마커 이미지 (파란색 포인트 등)
                        const imageSrc = 'https://t1.daumcdn.net/localimg/localimages/07/2012/img/marker_p.png';
                        const imageSize = new kakao.maps.Size(35, 39);
                        const markerImage = new kakao.maps.MarkerImage(imageSrc, imageSize);

                        myLocationMarker = new kakao.maps.Marker({
                            position: myLatLng,
                            image: markerImage,
                            map: map
                        });
                    }

                    map.panTo(myLatLng); // 내 위치로 부드럽게 중심 이동
                    map.setLevel(4);     // 근처 소화전이 잘 보이게 레벨 조정
                }, (err) => {
                    console.error("GPS 오류:", err);
                    alert("GPS를 켤 수 없거나 권한이 없습니다.");
                }, {
                    enableHighAccuracy: true // 정확도 우선 모드
                });
            } else {
                alert("이 브라우저에서는 위치 서비스를 사용할 수 없습니다.");
            }
        }
    </script>
</body>

</html>